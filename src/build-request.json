{
  "kind": "build_request",
  "title": "Fix live Sync Error caused by canister trap in getAllSurgeryCases (heap out of bounds)",
  "projectName": "Surgery Case Tracker",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Modify the backend canister (Canister ID: tcbtk-yyaaa-aaaaa-qfanq-cai) to prevent trapping with \"heap out of bounds\" when calling the query method getAllSurgeryCases by making the retrieval memory-safe (e.g., by adding a bounded/paginated retrieval API and/or limiting allocations during sorting), while preserving existing access control behavior.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Error from Canister tcbtk-yyaaa-aaaaa-qfanq-cai: Canister trapped: heap out of bounds... Method name: getAllSurgeryCases"
        ]
      },
      "acceptanceCriteria": [
        "Calling getAllSurgeryCases (or its replacement used by the frontend) no longer results in IC0502 / Reject code 5 for realistic user data volumes.",
        "The backend does not trap when a user has a large number of surgery cases; it either returns results successfully or returns a controlled error/result without trapping.",
        "Authorization rules remain unchanged (unauthorized callers still receive an Unauthorized error)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Update the frontend sync flow to avoid relying on unbounded getAllSurgeryCases calls (currently used in frontend/src/hooks/useSync.ts) by using the new bounded/paginated backend retrieval method(s) and/or using incremental retrieval (e.g., getUpdatedCases) so that sync works even when the user has many cases.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Method name: getAllSurgeryCases"
        ]
      },
      "acceptanceCriteria": [
        "The Sync action in the live app completes successfully without triggering a canister trap when the user has many cases.",
        "frontend/src/hooks/useSync.ts no longer makes assumptions that the entire case list can be fetched in a single call.",
        "Sync still correctly merges server and local cases and clears pendingSync on success."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Improve frontend error handling for backend trap/rejection errors during sync so the user sees a clear English message instead of the raw replica rejection details, while still logging the raw error to the console for debugging.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "In the live app there is an error message Sync Error: The replica returned a rejection error... Canister trapped: heap out of bounds."
        ]
      },
      "acceptanceCriteria": [
        "If the backend returns a replica rejection/trap during sync, the UI displays an English, user-friendly error (e.g., indicating the backend failed and to retry), and does not display the full raw request/rejection dump.",
        "The raw error details remain available in developer console logs for debugging.",
        "All user-facing error text added/modified for this fix is in English."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in backend/main.mo (no additional backend services).",
    "Do not edit any files under frontend/src/components/ui or other paths listed as immutable in SYSTEM_CONTEXT.",
    "Use English for all user-facing text."
  ],
  "nonGoals": [
    "Adding new authentication providers (Internet Identity remains the only auth).",
    "Introducing external databases or third-party backend services.",
    "Implementing real-time synchronization (e.g., websockets) beyond the existing sync button flow."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}